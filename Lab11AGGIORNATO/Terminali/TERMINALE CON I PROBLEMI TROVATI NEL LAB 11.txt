ubuntu@k8s-node:~$ curl -sSf https://get.k0s.sh | sudo sh
Downloading k0s from URL: https://github.com/k0sproject/k0s/releases/download/v1.34.3+k0s.0/k0s-v1.34.3+k0s.0-arm64
sh: 61: cannot create /usr/local/bin/k0s: Text file busy
ubuntu@k8s-node:~$ sudo k0s install controller --single 
Error: failed to install controller service: Init already exists: /etc/systemd/system/k0scontroller.service
ubuntu@k8s-node:~$ sudo k0s start
Error: already running
ubuntu@k8s-node:~$ ls
advanced-kubernetes  snap
ubuntu@k8s-node:~$ nano my-service.yaml
ubuntu@k8s-node:~$ nano my-deployment.yaml
ubuntu@k8s-node:~$ nano my-configmap.yaml
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml 
Error from server (BadRequest): error when creating "my-configmap.yaml": ConfigMap in version "v1" cannot be handled as a ConfigMap: json: cannot unmarshal array into Go struct field ConfigMap.data of type string
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml 
Error from server (BadRequest): error when creating "my-configmap.yaml": ConfigMap in version "v1" cannot be handled as a ConfigMap: json: cannot unmarshal array into Go struct field ConfigMap.data of type string
ubuntu@k8s-node:~$ nano my-deployment.yaml
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-deployment.yaml 
deployment.apps/rest-server-dep created
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-service.yaml
service/rest-server-svc created
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml 
Error from server (BadRequest): error when creating "my-configmap.yaml": ConfigMap in version "v1" cannot be handled as a ConfigMap: json: cannot unmarshal array into Go struct field ConfigMap.data of type string
ubuntu@k8s-node:~$ nano my-configmap.yaml
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml 
configmap/rest-server-config created
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS              RESTARTS   AGE
rest-server-dep-79bb7c7d98-t5wxp   0/1     ContainerCreating   0          80s
ubuntu@k8s-node:~$ sudo k0s kubectl describe pod rest-server-dep-79bb7c7d98-t5wxp
Name:             rest-server-dep-79bb7c7d98-t5wxp
Namespace:        default
Priority:         0
Service Account:  default
Node:             k8s-node/192.168.64.9
Start Time:       Fri, 23 Jan 2026 09:42:15 +0100
Labels:           app=rest-server
                  pod-template-hash=79bb7c7d98
Annotations:      <none>
Status:           Pending
IP:               
IPs:              <none>
Controlled By:    ReplicaSet/rest-server-dep-79bb7c7d98
Containers:
  rest-server:
    Container ID:   
    Image:          semplicementeria/rest-server:v1
    Image ID:       
    Port:           5000/TCP
    Host Port:      0/TCP
    State:          Waiting
      Reason:       ContainerCreating
    Ready:          False
    Restart Count:  0
    Environment:    <none>
    Mounts:
      /etc/my_res.json from config-volume (rw,path="my_res.json")
      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-9c82f (ro)
Conditions:
  Type                        Status
  PodReadyToStartContainers   False 
  Initialized                 True 
  Ready                       False 
  ContainersReady             False 
  PodScheduled                True 
Volumes:
  config-volume:
    Type:      ConfigMap (a volume populated by a ConfigMap)
    Name:      rest-server-config
    Optional:  false
  kube-api-access-9c82f:
    Type:                    Projected (a volume that contains injected data from multiple sources)
    TokenExpirationSeconds:  3607
    ConfigMapName:           kube-root-ca.crt
    Optional:                false
    DownwardAPI:             true
QoS Class:                   BestEffort
Node-Selectors:              <none>
Tolerations:                 node.kubernetes.io/not-ready:NoExecute op=Exists for 300s
                             node.kubernetes.io/unreachable:NoExecute op=Exists for 300s
Events:
  Type     Reason       Age                 From               Message
  ----     ------       ----                ----               -------
  Normal   Scheduled    110s                default-scheduler  Successfully assigned default/rest-server-dep-79bb7c7d98-t5wxp to k8s-node
  Warning  FailedMount  47s (x8 over 111s)  kubelet            MountVolume.SetUp failed for volume "config-volume" : configmap "rest-server-config" not found
ubuntu@k8s-node:~$ sudo k0s kubectl get configmap rest-server-config -o yaml
apiVersion: v1
data:
  my_res.json: |
    [
      {"distr": "deterministic", "params": {"fixed": 2}, "task": "sleep"},
      {"distr": "uniform", "params": {"T": 5}, "task": "cpu"}
    ]
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"my_res.json":"[\n  {\"distr\": \"deterministic\", \"params\": {\"fixed\": 2}, \"task\": \"sleep\"},\n  {\"distr\": \"uniform\", \"params\": {\"T\": 5}, \"task\": \"cpu\"}\n]\n"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"rest-server-config","namespace":"default"}}
  creationTimestamp: "2026-01-23T08:43:25Z"
  name: rest-server-config
  namespace: default
  resourceVersion: "1848"
  uid: 04df7d6b-afe6-4904-b65b-2893e6956918
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS              RESTARTS   AGE
rest-server-dep-79bb7c7d98-t5wxp   0/1     ContainerCreating   0          2m
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml 
configmap/rest-server-config unchanged
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS              RESTARTS   AGE
rest-server-dep-79bb7c7d98-t5wxp   0/1     ContainerCreating   0          2m11s
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-79bb7c7d98-t5wxp   1/1     Running   0          32m
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 1 ms: Couldn't connect to server
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-79bb7c7d98-t5wxp   1/1     Running   0          33m
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-79bb7c7d98-t5wxp   1/1     Running   0          33m
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~$ nano my-service.yaml 
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-deployment.yaml 
sudo k0s kubectl apply -f my-service.yaml
sudo k0s kubectl apply -f my-configmap.yaml

deployment.apps/rest-server-dep unchanged
service/rest-server-svc unchanged
configmap/rest-server-config unchanged
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-79bb7c7d98-t5wxp   1/1     Running   0          35m
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~$ sudo k0s kubectl port-forward pod/rest-server-dep-79bb7c7d98-t5wxp 30080:5000
Forwarding from 127.0.0.1:30080 -> 5000
Forwarding from [::1]:30080 -> 5000
Handling connection for 30080
E0123 10:18:42.676536  466414 portforward.go:424] "Unhandled Error" err="an error occurred forwarding 30080 -> 5000: error forwarding port 5000 to pod 819b272335a6602058dd00cc69e7bbcf2e039db9a70a499a04c2cfd983d630c5, uid : failed to execute portforward in network namespace \"/var/run/netns/cni-ae6f69be-5bf3-f414-59af-fcd999883524\": failed to connect to localhost:5000 inside namespace \"819b272335a6602058dd00cc69e7bbcf2e039db9a70a499a04c2cfd983d630c5\", IPv4: dial tcp4 127.0.0.1:5000: connect: connection refused IPv6 dial tcp6 [::1]:5000: connect: connection refused "
error: lost connection to pod
ubuntu@k8s-node:~$ sudo k0s kubectl logs rest-server-dep-79bb7c7d98-t5wxp
 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://10.244.0.6:5001
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 855-238-528
ubuntu@k8s-node:~$ sudo k0s kubectl port-forward pod/rest-server-dep-79bb7c7d98-t5wxp 30080:5001
Forwarding from 127.0.0.1:30080 -> 5001
Forwarding from [::1]:30080 -> 5001
Handling connection for 30080
^Cubuntu@k8s-node:~nano my-deployment.yaml
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-deployment.yaml 
deployment.apps/rest-server-dep configured
ubuntu@k8s-node:~$ nano my-service.yaml 
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-service.yaml
service/rest-server-svc configured
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ nano my-configmap.yaml 
ubuntu@k8s-node:~$ sudo k0s kubectl exec rest-server-dep-79bb7c7d98-t5wxp -- ls /app/resources
Error from server (NotFound): pods "rest-server-dep-79bb7c7d98-t5wxp" not found
ubuntu@k8s-node:~$ nano my-configmap.yaml 
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml
configmap/rest-server-config configured
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-5d655468d9-k7wx5   1/1     Running   0          3m31s
ubuntu@k8s-node:~$ sudo k0s kubectl exec rest-server-dep-79bb7c7d98-t5wxp -- ls /app/resources
Error from server (NotFound): pods "rest-server-dep-79bb7c7d98-t5wxp" not found
ubuntu@k8s-node:~$ sudo k0s kubectl exec rest-server-dep-5d655468d9-k7wx5 -- ls /app/resources
ls: cannot access '/app/resources': No such file or directory
command terminated with exit code 2
ubuntu@k8s-node:~$ nano my-configmap.yaml 
ubuntu@k8s-node:~$ nano my-deployment.yaml
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-deployment.yaml
error: error parsing my-deployment.yaml: error converting YAML to JSON: yaml: line 23: could not find expected ':'
ubuntu@k8s-node:~$ nano my-deployment.yaml
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-deployment.yaml
deployment.apps/rest-server-dep configured
ubuntu@k8s-node:~$ sudo k0s kubectl exec rest-server-dep-5d655468d9-k7wx5 -- ls -l /etc/my_res.json
Error from server (NotFound): pods "rest-server-dep-5d655468d9-k7wx5" not found
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-deployment.yaml
deployment.apps/rest-server-dep unchanged
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-66cb96cffb-v4dt5   1/1     Running   0          25s
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ nano my-service.yaml 
ubuntu@k8s-node:~$ nano my-deployment.yaml
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-deployment.yaml
deployment.apps/rest-server-dep configured
ubuntu@k8s-node:~$ nano my-configmap.yaml 
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml
configmap/rest-server-config configured
ubuntu@k8s-node:~$ ls
advanced-kubernetes  my-configmap.yaml  my-deployment.yaml  my-service.yaml  snap
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ sudo k0s kubectl logs rest-server-dep-66cb96cffb-v4dt5 
error: error from server (NotFound): pods "rest-server-dep-66cb96cffb-v4dt5" not found in namespace "default"
ubuntu@k8s-node:~$ sudo k0s kubectl logs deployment/rest-server-dep
 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://10.244.0.9:5001
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 598-041-419
10.244.0.1 - - [23/Jan/2026 09:33:19] "GET /response/v1/resources HTTP/1.1" 200 -
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-5d655468d9-5zwv9   1/1     Running   0          4m26s
ubuntu@k8s-node:~$ sudo k0s kubectl exec rest-server-dep-5d655468d9-5zwv9  -- ls -l /etc/my_res.json
-rw-r--r-- 0 root root 64 Jan 23 09:30 /etc/my_res.json
ubuntu@k8s-node:~$ sudo k0s kubectl exec rest-server-dep-5d655468d9-5zwv9 -- grep -r "my_res.json" .
./LAB11_assignment/configmap.yaml:  my_res.json: |
./LAB11_assignment/my-deployment.yaml:          mountPath: /etc/my_res.json # Percorso richiesto
./LAB11_assignment/my-deployment.yaml:          subPath: my_res.json
./LAB11_assignment/app.py:CONFIG_PATH = "/etc/my_res.json"
ubuntu@k8s-node:~$ sudo k0s kubectl exec rest-server-dep-5d655468d9-5zwv9 -- cat /etc/my_res.json
{
  "resource1": "Valore Alpha",
  "resource2": "Valore Beta"
}
ubuntu@k8s-node:~$ nano my-configmap.yaml 
ubuntu@k8s-node:~$ sudo k0s kubectl apply -f my-configmap.yaml
configmap/rest-server-config unchanged
ubuntu@k8s-node:~$ sudo k0s kubectl rollout restart deployment rest-server-dep
deployment.apps/rest-server-dep restarted
ubuntu@k8s-node:~$ sudo k0s kubectl exec deployment/rest-server-dep -- cat /etc/my_res.json
[
  {"distr": "deterministic", "params": {"fixed": 2}, "task": "sleep"}
]
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ sudo k0s kubectl rollout restart deployment rest-server-dep
deployment.apps/rest-server-dep restarted
ubuntu@k8s-node:~$ rollout restart
rollout: command not found
ubuntu@k8s-node:~$ kubectl get pods
No resources found in default namespace.
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-76997857b4-4n5ph   1/1     Running   0          41s
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ sudo k0s kubectl exec deployment/rest-server-dep -- cat /app/app.py
'''Write the python code to run a Flask server exposing a REST API that allows the creation/modification/deletion 
of resources offered by a "random response time" web application. Each resource must represent a generator of response times following a given random distribution, 
with specified parameter(s), mimicking the diverse computation time of some web application server'''

from flask import Flask, request, jsonify
import time, uuid, random
import numpy as np

#so we have a server that a user can use to create new random response time generators
#here we initialize the Flask app:
app = Flask(__name__)

# I create a global storage for the generators
generators = []

#Creation of the source (POST)
@app.route('/response/v1/resources', methods=['POST'])
def create_resource():
   # we have to make sure that the user actually went json:
    if not request.is_json:
        return "request must be JSON\n", 415 #error for the unsupported media type
   
   #now that we know it's JSON then we extract the data that has been requested: parsing of the JSON
    data = request.get_json()

   #then we extract the data and validate the fields that are our parameters we're interested into
    distr = data.get('distr')
    params = data.get('params')
    task = data.get('task')

   #now here i put some other errors
    if not distr or not params or not task:
      return "Parameters not available", 400 #the resource exists but the input is wrong
   #I'll put the same error for the invalid distribution type and if the task is not in cpu or sleep

    if distr not in ['exponential', 'deterministic', 'uniform']:
      return "Invalid distribution type\n", 400
   
    if task not in ['cpu', 'sleep']:
      return "Invalid task type\n", 400
    
    #creation of the resource
    resource_id = str(uuid.uuid4())
    new_resource = {
        "id": resource_id,
        "distr": distr,
        "params": params,
        "task": task
    }

    #we create a global list into which we can initialize our generators
    generators.append(new_resource)

    #every resource has to allocate memory in it so I have to create the following structure:
    
    
    #now I have to store them in a global list and append my new objects:
    return jsonify(new_resource), 201
 
#Then I have to repeat this step but for the GET part:
@app.route('/response/v1/resources', methods=['GET'])
def get_all_resources(): #this function is for all the generators in the list
   return jsonify(generators), 200

@app.route('/response/v1/resources/<string:id>', methods=['GET'])
def get_one_resource(id): #this function is only for one generator if found inside the list that we have generated before.
   for resource in generators:
      if resource["id"] == id:
         return jsonify(resource), 200  #to update the state 
   return "Resource not found\n", 404 #If it is not found
   
#Then I have the PUT part in which we have to update the generator list
@app.route('/response/v1/resources/<string:id>', methods=['PUT'])
def update_resource(id):
    if not request.is_json:
        return "Request must be JSON\n", 415
    data = request.get_json()

    for resource in generators:
        if resource["id"] == id:
            # Update fields if provided
            if "distr" in data:
                if data["distr"] not in ['exponential', 'deterministic', 'uniform']:
                    return "Invalid distribution type\n", 400
                resource["distr"] = data["distr"]
            if "params" in data:
                resource["params"] = data["params"]
            if "task" in data:
                if data["task"] not in ['cpu', 'sleep']:
                    return "Invalid task type\n", 400
                resource["task"] = data["task"]
            return jsonify(resource), 200

    return "Resource not found\n", 404

#From here I implement the DELETE part:
@app.route('/response/v1/resources/<string:id>', methods = ['DELETE'])
def delete_resource(id):
    for r in generators:
        if r["id"] == id:
            generators.remove(r)
            return "", 204
    return "Resource not found", 404

#And then we RUN: 
@app.route('/response/v1/resources/<string:id>/run', methods=['GET'])
def run_resource(id):
    for r in generators:
        if r["id"] == id:
            distr = r["distr"]
            params = r["params"]
            task = r["task"]

            # --- Generate random delay ---
            if distr == "deterministic":
                interval = params.get("fixed", 1)
            elif distr == "uniform":
                interval = np.random.uniform(0, params.get("T", 1))
            elif distr == "exponential":
                interval = np.random.exponential(1 / params.get("lambda", 1))
            else:
                return "Invalid distribution\n", 400

            start_time = time.time()

            if task == "sleep":
                # I/O-bound delay (low CPU)
                time.sleep(interval)

            elif task == "cpu":
                # CPU-bound delay (high CPU)
                while time.time() - start_time < interval:
                    x = time.time() - start_time
                    x = float(x) / 3.141592
                    x = float(3.141592) / x

            duration = round(time.time() - start_time, 3)

            return jsonify({
                "id": id,
                "delay": duration,
                "task": task,
                "distr": distr,
                "status": "completed"
            }), 200

    return "Resource not found\n", 404

#tests for the app.rout:
@app.route("/")
def welcome():
    return "<h1>The random response time server is running!</h1>\n"

@app.route("/test/")
def test():
    return "<h1>This is the test folder.</h1>\n"

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5001, debug=True)


# TEST: first we have to run the code to run the server in a terminal. In the other...
'''
1) curl -X POST http://localhost:5001/response/v1/resources \
     -H "Content-Type: application/json" \
     -d '{"distr": "deterministic", "params": {"fixed": 3}, "task": "cpu"}' (here we can change the deterministic 
     with the uniform or the exponential by changing the name and the values like...
     
     -d '{"distr": "uniform", "params": {"T": 10}, "task": "sleep"}'
     or:
     -d '{"distr": "exponential", "params": {"lambda": 0.5}, "task": "sleep"}')

2) curl http://localhost:5001/response/v1/resources to see if the server has saved all the resources
and then we run them:
curl http://localhost:5001/response/v1/resources/<ID>/run

3) We can update a resource (for example to a 1-second fixed CPU task):
curl -X PUT http://localhost:5001/response/v1/resources/<ID> \
     -H "Content-Type: application/json" \
     -d '{"distr": "deterministic", "params": {"fixed": 1}, "task": "cpu"}' 

4) and delete it:
curl -X DELETE http://localhost:5001/response/v1/resources/<ID>

5) curl http://localhost:5001/response/v1/resources final check to see if all went right
'''ubuntu@k8s-node:~$ cd
ubuntu@k8s-node:~$ ls
advanced-kubernetes  my-configmap.yaml  my-deployment.yaml  my-service.yaml  snap
ubuntu@k8s-node:~$ nano LAB11_assignment/app.py
ubuntu@k8s-node:~$ sudo k0s kubectl create configmap app-code --from-file=app.py=./LAB11_assignment/app.py
error: error reading ./LAB11_assignment/app.py: no such file or directory
ubuntu@k8s-node:~$ curl -sSf https://get.k0s.sh | sudo sh
Downloading k0s from URL: https://github.com/k0sproject/k0s/releases/download/v1.34.3+k0s.0/k0s-v1.34.3+k0s.0-arm64
sh: 61: cannot create /usr/local/bin/k0s: Text file busy
ubuntu@k8s-node:~$ sudo k0s kubectl get pods -w
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-76997857b4-4n5ph   1/1     Running   0          8m6s
^Cubuntu@k8s-node:~curl http://localhost:30080/response/v1/resourceseses
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ nano app.py
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resourceses
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ nano app.py 
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ ls
advanced-kubernetes  app.py  my-configmap.yaml  my-deployment.yaml  my-service.yaml  snap
ubuntu@k8s-node:~$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-76997857b4-4n5ph   1/1     Running   0          13m
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resourceses
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~$ nano app.py 
ubuntu@k8s-node:~$ nano app.py 
ubuntu@k8s-node:~$ ls
advanced-kubernetes  app.py  my-configmap.yaml  my-deployment.yaml  my-service.yaml  snap
ubuntu@k8s-node:~$ nano my-configmap.yaml 
ubuntu@k8s-node:~$ nano my-service.yaml 
ubuntu@k8s-node:~$ nano my-deployment.yaml 
ubuntu@k8s-node:~$ multipass transfer -r LAB11_assignment/ ubuntu@k8s-node:/home/ubuntu/
Command 'multipass' not found, but can be installed with:
sudo snap install multipass
ubuntu@k8s-node:~$ ls
LAB11_assignment  advanced-kubernetes  app.py  my-configmap.yaml  my-deployment.yaml  my-service.yaml  snap
ubuntu@k8s-node:~$ cd LAB11_assignment/
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-service.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml 
sudo k0s kubectl apply -f my-service.yaml
sudo k0s kubectl apply -f my-configmap.yaml
deployment.apps/rest-server-dep configured
service/rest-server-svc configured
configmap/rest-server-config configured
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s get pods
Error: unknown command "get" for "k0s"
Run 'k0s --help' for usage.
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-6bd8f5cf47-zqsgl   1/1     Running   0          20s
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resourceses
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs rest-server-dep-6bd8f5cf47-zqsgl
 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://10.244.0.12:5001
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 216-287-467
ubuntu@k8s-node:~/LAB11_assignment$ nano my-service.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml 
sudo k0s kubectl apply -f my-service.yaml
sudo k0s kubectl apply -f my-configmap.yaml
deployment.apps/rest-server-dep configured
service/rest-server-svc configured
configmap/rest-server-config unchanged
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl exec deployment/rest-server-dep -- cat /etc/my_res.json
{
  "resource1": "Valore Alpha",
  "resource2": "Valore Beta"
}
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl rollout restart deployment rest-server-dep
deployment.apps/rest-server-dep restarted
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl rollout restart deployment rest-server-dep-6bd8f5cf47-zqsgl
Error from server (NotFound): deployments.apps "rest-server-dep-6bd8f5cf47-zqsgl" not found
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs rest-server-dep-6bd8f5cf47-zqsgl
error: error from server (NotFound): pods "rest-server-dep-6bd8f5cf47-zqsgl" not found in namespace "default"
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s get pods
Error: unknown command "get" for "k0s"
Run 'k0s --help' for usage.
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-6c4f99b544-shncb   1/1     Running   0          60s
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/r
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/
<h1>The random response time server is running!</h1>
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1
<!doctype html>
<html lang=en>
<title>404 Not Found</title>
<h1>Not Found</h1>
<p>The requested URL was not found on the server. If you entered the URL manually please check your spelling and try again.</p>
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs rest-server-dep-6bd8f5cf47-zqsgl
error: error from server (NotFound): pods "rest-server-dep-6bd8f5cf47-zqsgl" not found in namespace "default"
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs rest-server-dep-6c4f99b544-shncb
 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://10.244.0.14:5001
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 627-415-769
10.244.0.1 - - [23/Jan/2026 10:18:14] "GET /response/v1/resources HTTP/1.1" 200 -
10.244.0.1 - - [23/Jan/2026 10:18:21] "GET /response/v1/r HTTP/1.1" 404 -
10.244.0.1 - - [23/Jan/2026 10:18:23] "GET /response/v1/ HTTP/1.1" 404 -
10.244.0.1 - - [23/Jan/2026 10:18:25] "GET /response/v1 HTTP/1.1" 404 -
10.244.0.1 - - [23/Jan/2026 10:18:28] "GET / HTTP/1.1" 200 -
10.244.0.1 - - [23/Jan/2026 10:18:41] "GET /response HTTP/1.1" 404 -
10.244.0.1 - - [23/Jan/2026 10:18:52] "GET /response/v1 HTTP/1.1" 404 -
10.244.0.1 - - [23/Jan/2026 10:18:56] "GET /response/v1/resources HTTP/1.1" 200 -
ubuntu@k8s-node:~/LAB11_assignment$ la
Dockerfile  app.py  configmap.yaml  my-configmap.yaml  my-deployment.yaml  my-service.yaml
ubuntu@k8s-node:~/LAB11_assignment$ nano app.py
ubuntu@k8s-node:~/LAB11_assignment$ nano configmap.yaml
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml 
sudo k0s kubectl apply -f my-service.yaml
sudo k0s kubectl apply -f my-configmap.yaml
deployment.apps/rest-server-dep unchanged
service/rest-server-svc unchanged
configmap/rest-server-config configured
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-6c4f99b544-shncb   1/1     Running   0          7m15s
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl rollout restart deployment rest-server-dep
deployment.apps/rest-server-dep restarted
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get configmap rest-server-config -o yaml
apiVersion: v1
data:
  my_res.json: |
    [
      {
        "name": "resource1",
        "value": "Valore Alpha"
      },
      {
        "name": "resource2",
        "value": "Valore Beta"
      }
    ]
kind: ConfigMap
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration: |
      {"apiVersion":"v1","data":{"my_res.json":"[\n  {\n    \"name\": \"resource1\",\n    \"value\": \"Valore Alpha\"\n  },\n  {\n    \"name\": \"resource2\",\n    \"value\": \"Valore Beta\"\n  }\n]\n"},"kind":"ConfigMap","metadata":{"annotations":{},"name":"rest-server-config","namespace":"default"}}
  creationTimestamp: "2026-01-23T08:43:25Z"
  name: rest-server-config
  namespace: default
  resourceVersion: "5812"
  uid: 04df7d6b-afe6-4904-b65b-2893e6956918
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get deployment rest-server-dep -o yaml | grep -A 10 volumeMounts
      {"apiVersion":"apps/v1","kind":"Deployment","metadata":{"annotations":{},"name":"rest-server-dep","namespace":"default"},"spec":{"replicas":1,"selector":{"matchLabels":{"app":"rest-server"}},"template":{"metadata":{"labels":{"app":"rest-server"}},"spec":{"containers":[{"image":"semplicementeria/rest-server:v1","name":"rest-server","ports":[{"containerPort":5001}],"volumeMounts":[{"mountPath":"/etc/my_res.json","name":"config-volume","subPath":"my_res.json"}]}],"volumes":[{"configMap":{"name":"rest-server-config"},"name":"config-volume"}]}}}}
  creationTimestamp: "2026-01-23T08:42:15Z"
  generation: 10
  name: rest-server-dep
  namespace: default
  resourceVersion: "5870"
  uid: 33d733f0-1df6-4f60-86eb-a676e3ea2041
spec:
  progressDeadlineSeconds: 600
  replicas: 1
  revisionHistoryLimit: 10
--
        volumeMounts:
        - mountPath: /etc/my_res.json
          name: config-volume
          subPath: my_res.json
      dnsPolicy: ClusterFirst
      restartPolicy: Always
      schedulerName: default-scheduler
      securityContext: {}
      terminationGracePeriodSeconds: 30
      volumes:
      - configMap:
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
rest-server-dep-b594f9bb8-c7xt6   1/1     Running   0          110s
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs rest-server-dep-b594f9bb8-c7xt6
 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://10.244.0.15:5001
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 125-047-078
10.244.0.1 - - [23/Jan/2026 10:24:46] "GET /response/v1/resources HTTP/1.1" 200 -
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl exec rest-server-dep-b594f9bb8-c7xt6 -- cat app.py
'''Write the python code to run a Flask server exposing a REST API that allows the creation/modification/deletion 
of resources offered by a "random response time" web application. Each resource must represent a generator of response times following a given random distribution, 
with specified parameter(s), mimicking the diverse computation time of some web application server'''

from flask import Flask, request, jsonify
import time, uuid, random
import numpy as np

#so we have a server that a user can use to create new random response time generators
#here we initialize the Flask app:
app = Flask(__name__)

# I create a global storage for the generators
generators = []

#Creation of the source (POST)
@app.route('/response/v1/resources', methods=['POST'])
def create_resource():
   # we have to make sure that the user actually went json:
    if not request.is_json:
        return "request must be JSON\n", 415 #error for the unsupported media type
   
   #now that we know it's JSON then we extract the data that has been requested: parsing of the JSON
    data = request.get_json()

   #then we extract the data and validate the fields that are our parameters we're interested into
    distr = data.get('distr')
    params = data.get('params')
    task = data.get('task')

   #now here i put some other errors
    if not distr or not params or not task:
      return "Parameters not available", 400 #the resource exists but the input is wrong
   #I'll put the same error for the invalid distribution type and if the task is not in cpu or sleep

    if distr not in ['exponential', 'deterministic', 'uniform']:
      return "Invalid distribution type\n", 400
   
    if task not in ['cpu', 'sleep']:
      return "Invalid task type\n", 400
    
    #creation of the resource
    resource_id = str(uuid.uuid4())
    new_resource = {
        "id": resource_id,
        "distr": distr,
        "params": params,
        "task": task
    }

    #we create a global list into which we can initialize our generators
    generators.append(new_resource)

    #every resource has to allocate memory in it so I have to create the following structure:
    
    
    #now I have to store them in a global list and append my new objects:
    return jsonify(new_resource), 201
 
#Then I have to repeat this step but for the GET part:
@app.route('/response/v1/resources', methods=['GET'])
def get_all_resources(): #this function is for all the generators in the list
   return jsonify(generators), 200

@app.route('/response/v1/resources/<string:id>', methods=['GET'])
def get_one_resource(id): #this function is only for one generator if found inside the list that we have generated before.
   for resource in generators:
      if resource["id"] == id:
         return jsonify(resource), 200  #to update the state 
   return "Resource not found\n", 404 #If it is not found
   
#Then I have the PUT part in which we have to update the generator list
@app.route('/response/v1/resources/<string:id>', methods=['PUT'])
def update_resource(id):
    if not request.is_json:
        return "Request must be JSON\n", 415
    data = request.get_json()

    for resource in generators:
        if resource["id"] == id:
            # Update fields if provided
            if "distr" in data:
                if data["distr"] not in ['exponential', 'deterministic', 'uniform']:
                    return "Invalid distribution type\n", 400
                resource["distr"] = data["distr"]
            if "params" in data:
                resource["params"] = data["params"]
            if "task" in data:
                if data["task"] not in ['cpu', 'sleep']:
                    return "Invalid task type\n", 400
                resource["task"] = data["task"]
            return jsonify(resource), 200

    return "Resource not found\n", 404

#From here I implement the DELETE part:
@app.route('/response/v1/resources/<string:id>', methods = ['DELETE'])
def delete_resource(id):
    for r in generators:
        if r["id"] == id:
            generators.remove(r)
            return "", 204
    return "Resource not found", 404

#And then we RUN: 
@app.route('/response/v1/resources/<string:id>/run', methods=['GET'])
def run_resource(id):
    for r in generators:
        if r["id"] == id:
            distr = r["distr"]
            params = r["params"]
            task = r["task"]

            # --- Generate random delay ---
            if distr == "deterministic":
                interval = params.get("fixed", 1)
            elif distr == "uniform":
                interval = np.random.uniform(0, params.get("T", 1))
            elif distr == "exponential":
                interval = np.random.exponential(1 / params.get("lambda", 1))
            else:
                return "Invalid distribution\n", 400

            start_time = time.time()

            if task == "sleep":
                # I/O-bound delay (low CPU)
                time.sleep(interval)

            elif task == "cpu":
                # CPU-bound delay (high CPU)
                while time.time() - start_time < interval:
                    x = time.time() - start_time
                    x = float(x) / 3.141592
                    x = float(3.141592) / x

            duration = round(time.time() - start_time, 3)

            return jsonify({
                "id": id,
                "delay": duration,
                "task": task,
                "distr": distr,
                "status": "completed"
            }), 200

    return "Resource not found\n", 404

#tests for the app.rout:
@app.route("/")
def welcome():
    return "<h1>The random response time server is running!</h1>\n"

@app.route("/test/")
def test():
    return "<h1>This is the test folder.</h1>\n"

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5001, debug=True)


# TEST: first we have to run the code to run the server in a terminal. In the other...
'''
1) curl -X POST http://localhost:5001/response/v1/resources \
     -H "Content-Type: application/json" \
     -d '{"distr": "deterministic", "params": {"fixed": 3}, "task": "cpu"}' (here we can change the deterministic 
     with the uniform or the exponential by changing the name and the values like...
     
     -d '{"distr": "uniform", "params": {"T": 10}, "task": "sleep"}'
     or:
     -d '{"distr": "exponential", "params": {"lambda": 0.5}, "task": "sleep"}')

2) curl http://localhost:5001/response/v1/resources to see if the server has saved all the resources
and then we run them:
curl http://localhost:5001/response/v1/resources/<ID>/run

3) We can update a resource (for example to a 1-second fixed CPU task):
curl -X PUT http://localhost:5001/response/v1/resources/<ID> \
     -H "Content-Type: application/json" \
     -d '{"distr": "deterministic", "params": {"fixed": 1}, "task": "cpu"}' 

4) and delete it:
curl -X DELETE http://localhost:5001/response/v1/resources/<ID>

5) curl http://localhost:5001/response/v1/resources final check to see if all went right
'''ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl exec rest-server-dep-b594f9bb8-c7xt6 -- python3 -c "import json; print(json.load(open('/etc/my_res.json')))"
[{'name': 'resource1', 'value': 'Valore Alpha'}, {'name': 'resource2', 'value': 'Valore Beta'}]
ubuntu@k8s-node:~/LAB11_assignment$ ls
Dockerfile  app.py  configmap.yaml  my-configmap.yaml  my-deployment.yaml  my-service.yaml
ubuntu@k8s-node:~/LAB11_assignment$ nano app.py
ubuntu@k8s-node:~/LAB11_assignment$ rm app.py
ubuntu@k8s-node:~/LAB11_assignment$ nano app.py
ubuntu@k8s-node:~/LAB11_assignment$ nano app.py
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml
deployment.apps/rest-server-dep unchanged
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
rest-server-dep-b594f9bb8-c7xt6   1/1     Running   0          7m38s
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
rest-server-dep-b594f9bb8-c7xt6   1/1     Running   0          8m28s
ubuntu@k8s-node:~/LAB11_assignment$ ls
Dockerfile  app.py  configmap.yaml  my-configmap.yaml  my-deployment.yaml  my-service.yaml
ubuntu@k8s-node:~/LAB11_assignment$ nano app.py
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl exec $(sudo k0s kubectl get pods -l app=rest-server -o name) -- cat app.py
'''Write the python code to run a Flask server exposing a REST API that allows the creation/modification/deletion 
of resources offered by a "random response time" web application. Each resource must represent a generator of response times following a given random distribution, 
with specified parameter(s), mimicking the diverse computation time of some web application server'''

from flask import Flask, request, jsonify
import time, uuid, random
import numpy as np

#so we have a server that a user can use to create new random response time generators
#here we initialize the Flask app:
app = Flask(__name__)

# I create a global storage for the generators
generators = []

#Creation of the source (POST)
@app.route('/response/v1/resources', methods=['POST'])
def create_resource():
   # we have to make sure that the user actually went json:
    if not request.is_json:
        return "request must be JSON\n", 415 #error for the unsupported media type
   
   #now that we know it's JSON then we extract the data that has been requested: parsing of the JSON
    data = request.get_json()

   #then we extract the data and validate the fields that are our parameters we're interested into
    distr = data.get('distr')
    params = data.get('params')
    task = data.get('task')

   #now here i put some other errors
    if not distr or not params or not task:
      return "Parameters not available", 400 #the resource exists but the input is wrong
   #I'll put the same error for the invalid distribution type and if the task is not in cpu or sleep

    if distr not in ['exponential', 'deterministic', 'uniform']:
      return "Invalid distribution type\n", 400
   
    if task not in ['cpu', 'sleep']:
      return "Invalid task type\n", 400
    
    #creation of the resource
    resource_id = str(uuid.uuid4())
    new_resource = {
        "id": resource_id,
        "distr": distr,
        "params": params,
        "task": task
    }

    #we create a global list into which we can initialize our generators
    generators.append(new_resource)

    #every resource has to allocate memory in it so I have to create the following structure:
    
    
    #now I have to store them in a global list and append my new objects:
    return jsonify(new_resource), 201
 
#Then I have to repeat this step but for the GET part:
@app.route('/response/v1/resources', methods=['GET'])
def get_all_resources(): #this function is for all the generators in the list
   return jsonify(generators), 200

@app.route('/response/v1/resources/<string:id>', methods=['GET'])
def get_one_resource(id): #this function is only for one generator if found inside the list that we have generated before.
   for resource in generators:
      if resource["id"] == id:
         return jsonify(resource), 200  #to update the state 
   return "Resource not found\n", 404 #If it is not found
   
#Then I have the PUT part in which we have to update the generator list
@app.route('/response/v1/resources/<string:id>', methods=['PUT'])
def update_resource(id):
    if not request.is_json:
        return "Request must be JSON\n", 415
    data = request.get_json()

    for resource in generators:
        if resource["id"] == id:
            # Update fields if provided
            if "distr" in data:
                if data["distr"] not in ['exponential', 'deterministic', 'uniform']:
                    return "Invalid distribution type\n", 400
                resource["distr"] = data["distr"]
            if "params" in data:
                resource["params"] = data["params"]
            if "task" in data:
                if data["task"] not in ['cpu', 'sleep']:
                    return "Invalid task type\n", 400
                resource["task"] = data["task"]
            return jsonify(resource), 200

    return "Resource not found\n", 404

#From here I implement the DELETE part:
@app.route('/response/v1/resources/<string:id>', methods = ['DELETE'])
def delete_resource(id):
    for r in generators:
        if r["id"] == id:
            generators.remove(r)
            return "", 204
    return "Resource not found", 404

#And then we RUN: 
@app.route('/response/v1/resources/<string:id>/run', methods=['GET'])
def run_resource(id):
    for r in generators:
        if r["id"] == id:
            distr = r["distr"]
            params = r["params"]
            task = r["task"]

            # --- Generate random delay ---
            if distr == "deterministic":
                interval = params.get("fixed", 1)
            elif distr == "uniform":
                interval = np.random.uniform(0, params.get("T", 1))
            elif distr == "exponential":
                interval = np.random.exponential(1 / params.get("lambda", 1))
            else:
                return "Invalid distribution\n", 400

            start_time = time.time()

            if task == "sleep":
                # I/O-bound delay (low CPU)
                time.sleep(interval)

            elif task == "cpu":
                # CPU-bound delay (high CPU)
                while time.time() - start_time < interval:
                    x = time.time() - start_time
                    x = float(x) / 3.141592
                    x = float(3.141592) / x

            duration = round(time.time() - start_time, 3)

            return jsonify({
                "id": id,
                "delay": duration,
                "task": task,
                "distr": distr,
                "status": "completed"
            }), 200

    return "Resource not found\n", 404

#tests for the app.rout:
@app.route("/")
def welcome():
    return "<h1>The random response time server is running!</h1>\n"

@app.route("/test/")
def test():
    return "<h1>This is the test folder.</h1>\n"

if __name__ == '__main__':
    app.run(host="0.0.0.0", port=5001, debug=True)


# TEST: first we have to run the code to run the server in a terminal. In the other...
'''
1) curl -X POST http://localhost:5001/response/v1/resources \
     -H "Content-Type: application/json" \
     -d '{"distr": "deterministic", "params": {"fixed": 3}, "task": "cpu"}' (here we can change the deterministic 
     with the uniform or the exponential by changing the name and the values like...
     
     -d '{"distr": "uniform", "params": {"T": 10}, "task": "sleep"}'
     or:
     -d '{"distr": "exponential", "params": {"lambda": 0.5}, "task": "sleep"}')

2) curl http://localhost:5001/response/v1/resources to see if the server has saved all the resources
and then we run them:
curl http://localhost:5001/response/v1/resources/<ID>/run

3) We can update a resource (for example to a 1-second fixed CPU task):
curl -X PUT http://localhost:5001/response/v1/resources/<ID> \
     -H "Content-Type: application/json" \
     -d '{"distr": "deterministic", "params": {"fixed": 1}, "task": "cpu"}' 

4) and delete it:
curl -X DELETE http://localhost:5001/response/v1/resources/<ID>

5) curl http://localhost:5001/response/v1/resources final check to see if all went right
'''ubuntu@k8s-node:~/LAB11_assignmensudo k0s kubectl apply -f my-deployment.yaml ml 
sudo k0s kubectl apply -f my-service.yaml
sudo k0s kubectl apply -f my-configmap.yaml
deployment.apps/rest-server-dep unchanged
service/rest-server-svc unchanged
configmap/rest-server-config unchanged
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                              READY   STATUS    RESTARTS   AGE
rest-server-dep-b594f9bb8-c7xt6   1/1     Running   0          10m
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl rollout restart deployment rest-server-dep
deployment.apps/rest-server-dep restarted
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml 
deployment.apps/rest-server-dep configured
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                               READY   STATUS    RESTARTS   AGE
rest-server-dep-694b66dfc4-4d5c8   1/1     Running   0          17s
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs rest-server-dep-694b66dfc4-4d5c8
 * Serving Flask app 'app'
 * Debug mode: on
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5001
 * Running on http://10.244.0.17:5001
Press CTRL+C to quit
 * Restarting with stat
 * Debugger is active!
 * Debugger PIN: 530-560-396
10.244.0.1 - - [23/Jan/2026 10:36:23] "GET /response/v1/resources HTTP/1.1" 200 -
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml 
sudo k0s kubectl apply -f my-service.yaml
sudo k0s kubectl apply -f my-configmap.yaml
deployment.apps/rest-server-dep unchanged
service/rest-server-svc unchanged
configmap/rest-server-config unchanged
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[]
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl rollout restart deployment rest-server-dep
deployment.apps/rest-server-dep restarted
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl exec -it $(sudo k0s kubectl get pods -l app=rest-server -o name) -- grep "load_boot" app.py
command terminated with exit code 1
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml
deployment.apps/rest-server-dep configured
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl rollout restart deployment rest-server-dep
deployment.apps/rest-server-dep restarted
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                               READY   STATUS              RESTARTS   AGE
rest-server-dep-7746488b4d-hzs9f   1/1     Running             0          2m5s
rest-server-dep-7bffbd6f8-tbdkz    1/1     Terminating         0          18s
rest-server-dep-b869c59bd-4tjtm    0/1     ContainerCreating   0          13s
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get pods
NAME                              READY   STATUS        RESTARTS   AGE
rest-server-dep-7bffbd6f8-tbdkz   1/1     Terminating   0          22s
rest-server-dep-b869c59bd-4tjtm   1/1     Running       0          17s
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl exec -it $(sudo k0s kubectl get pods -l app=rest-server -o name) -- grep "load_boot" app.py
def load_boot_resources():
load_boot_resources()
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
curl: (7) Failed to connect to localhost port 30080 after 0 ms: Couldn't connect to server
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs $(sudo k0s kubectl get pods -l app=rest-server -o name)
Risorse caricate con successo da /etc/my_res.json
 * Serving Flask app 'app'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://10.244.0.20:5000
Press CTRL+C to quit
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get svc rest-server-svc
NAME              TYPE       CLUSTER-IP       EXTERNAL-IP   PORT(S)        AGE
rest-server-svc   NodePort   10.102.235.211   <none>        80:30080/TCP   121m
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-service.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get endpoints rest-server-svc
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME              ENDPOINTS          AGE
rest-server-svc   10.244.0.20:5001   123m
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl logs $(sudo k0s kubectl get pods -l app=rest-server -o name)
Risorse caricate con successo da /etc/my_res.json
 * Serving Flask app 'app'
 * Debug mode: off
WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
 * Running on all addresses (0.0.0.0)
 * Running on http://127.0.0.1:5000
 * Running on http://10.244.0.20:5000
Press CTRL+C to quit
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl exec $(sudo k0s kubectl get pods -l app=rest-server -o name) -- ls -l /etc/my_res.json
-rw-r--r-- 1 root root 126 Jan 23 10:42 /etc/my_res.json
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-service.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl apply -f my-deployment.yaml
sudo k0s kubectl apply -f my-service.yaml
deployment.apps/rest-server-dep configured
service/rest-server-svc configured
ubuntu@k8s-node:~/LAB11_assignment$ sudo k0s kubectl get endpoints rest-server-svc
Warning: v1 Endpoints is deprecated in v1.33+; use discovery.k8s.io/v1 EndpointSlice
NAME              ENDPOINTS          AGE
rest-server-svc   10.244.0.21:5000   125m
ubuntu@k8s-node:~/LAB11_assignment$ curl http://localhost:30080/response/v1/resources
[{"id":"3db35575-32e5-4f97-8bee-2b900a815d7b","name":"resource1","value":"Valore Alpha"},{"id":"e7ede265-e915-41d4-af66-5cc26b218d76","name":"resource2","value":"Valore Beta"}]
ubuntu@k8s-node:~/LAB11_assignment$ nano app.py
ubuntu@k8s-node:~/LAB11_assignment$ nano my-service.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-configmap.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano my-deployment.yaml 
ubuntu@k8s-node:~/LAB11_assignment$ nano Dockerfile 
ubuntu@k8s-node:~/LAB11_assignment$ ls
Dockerfile  app.py  configmap.yaml  my-configmap.yaml  my-deployment.yaml  my-service.yaml
ubuntu@k8s-node:~/LAB11_assignment$ cd
ubuntu@k8s-node:~$ 
